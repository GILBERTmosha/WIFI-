<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOSHARUTA WiFi - Management System</title>
    <style>
        :root { --primary: #22d3ee; --bg: #0f172a; --card: #1e293b; --danger: #f43f5e; --success: #10b981; --edit: #eab308; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #f8fafc; margin: 0; padding: 10px; }
        .container { max-width: 600px; margin: auto; background: var(--card); padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #334155; }
        .hidden { display: none; }
        
        .menu { display: flex; justify-content: space-around; margin-bottom: 20px; border-bottom: 2px solid #334155; }
        .menu button { background: none; border: none; color: #94a3b8; padding: 10px; cursor: pointer; font-weight: bold; font-size: 11px; }
        .menu button.active { color: var(--primary); border-bottom: 3px solid var(--primary); }

        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; outline: none; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 5px; transition: 0.2s; }
        .btn-save { background: var(--success); color: white; }
        .btn-update { background: var(--edit); color: black; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 10px; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #334155; }
        .total-box { background: #064e3b; padding: 12px; border-radius: 10px; text-align: center; margin-top: 15px; font-size: 18px; color: #34d399; font-weight: bold; }
        
        .action-container { display: flex; gap: 4px; }
        .action-icon { cursor: pointer; font-size: 16px; background: none; border: none; padding: 0; }
        .backup-section { background: #0f172a; padding: 15px; border-radius: 15px; margin-top: 20px; border: 1px dashed var(--primary); text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <div id="login-section">
        <h2 style="text-align:center">üì° MOSHARUTA ACCESS</h2>
        <input type="email" id="emailIn" placeholder="Weka Email Yako">
        <input type="password" id="passIn" placeholder="Password">
        <button class="btn btn-save" onclick="handleLogin()">INGIA</button>
    </div>

    <div id="main-content" class="hidden">
        <div style="text-align:center; margin-bottom:10px;"><small id="userLabel"></small></div>
        
        <div class="menu">
            <button id="tab1" class="active" onclick="switchTab('calc')">CALC</button>
            <button id="tab2" onclick="switchTab('entry')">SAJILI</button>
            <button id="tab3" onclick="switchTab('list')">MAUZO</button>
            <button id="tab4" class="hidden" onclick="switchTab('admin')">ADMIN VIEW</button>
        </div>

        <div id="calc-section">
            <input type="text" id="display" style="text-align:right; font-size:24px;" placeholder="0" readonly>
            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:8px;">
                <button class="btn" onclick="clearC()" style="background:#ef4444">C</button>
                <button class="btn" onclick="press('/')" style="background:#334155">/</button>
                <button class="btn" onclick="press('*')" style="background:#334155">√ó</button>
                <button class="btn" onclick="press('-')" style="background:#334155">-</button>
                <button class="btn" onclick="press('7')" style="background:#475569">7</button>
                <button class="btn" onclick="press('8')" style="background:#475569">8</button>
                <button class="btn" onclick="press('9')" style="background:#475569">9</button>
                <button class="btn" onclick="press('+')" style="background:#334155">+</button>
                <button class="btn" onclick="calcResult()" style="background:var(--success); grid-row: span 3">=</button>
                <button class="btn" onclick="press('4')" style="background:#475569">4</button>
                <button class="btn" onclick="press('5')" style="background:#475569">5</button>
                <button class="btn" onclick="press('6')" style="background:#475569">6</button>
                <button class="btn" onclick="press('1')" style="background:#475569">1</button>
                <button class="btn" onclick="press('2')" style="background:#475569">2</button>
                <button class="btn" onclick="press('3')" style="background:#475569">3</button>
                <button class="btn" onclick="press('0')" style="grid-column: span 2; background:#475569">0</button>
                <button class="btn" onclick="press('.')" style="background:#475569">.</button>
            </div>
        </div>

        <div id="entry-section" class="hidden">
            <h3 id="formHeader">üìù Sajili Malipo Mpya</h3>
            <input type="hidden" id="editIndex" value="-1">
            <input type="text" id="mName" placeholder="Jina la Mteja">
            <input type="text" id="mPhone" placeholder="Namba ya Simu">
            <input type="number" id="mAmount" placeholder="Kiasi (Tsh)">
            <button id="saveBtn" class="btn btn-save" onclick="saveRecord()">HIFADHI</button>
            <button id="cancelEditBtn" class="btn hidden" style="background:#475569" onclick="resetForm()">GHAIRI</button>
        </div>

        <div id="list-section" class="hidden">
            <h4>Mauzo Yako Leo</h4>
            <div id="userList"></div>
            <div class="total-box">JUMLA: <span id="userTotal">0</span> /=</div>

            <div class="backup-section">
                <p style="font-size:11px; margin-bottom:10px;">üîê <b>USER BACKUP SYSTEM</b></p>
                <div id="uBackupCodeDisp" style="color:var(--primary); font-family:monospace; margin-bottom:10px;">CODE: ----</div>
                <button class="btn" style="background:#334155; font-size:10px; width:45%;" onclick="genUserBackup()">TENGENEZA CODE</button>
                <button class="btn" style="background:#1e293b; border:1px solid var(--primary); font-size:10px; width:45%;" onclick="restoreUserBackup()">RUDISHA DATA</button>
            </div>
        </div>

        <div id="admin-section" class="hidden">
            <h3 style="color:var(--danger)">üëë Admin Dashboard (Kingshamo)</h3>
            <table>
                <thead>
                    <tr><th>User</th><th>Mteja</th><th>Tsh</th><th>Action</th></tr>
                </thead>
                <tbody id="adminTable"></tbody>
            </table>
            <div class="total-box">JUMLA KUU: <span id="grandTotal">0</span> /=</div>
        </div>

        <button class="btn" style="background:#475569; margin-top:30px" onclick="location.reload()">LOGOUT</button>
    </div>
</div>

<script>
    const _ADMIN_EMAIL = "kingshamo47@gmail.com";
    const _ADMIN_PASS = "2007+";
    const _USER_PASS = "MOSHA";

    let currentUser = "";
    let isAdminUser = false;

    function handleLogin() {
        let e = document.getElementById('emailIn').value.trim();
        let p = document.getElementById('passIn').value.trim();
        if (e === _ADMIN_EMAIL && p === _ADMIN_PASS) {
            isAdminUser = true; currentUser = e;
            document.getElementById('tab4').classList.remove('hidden');
        } else if (e && p === _USER_PASS) {
            isAdminUser = false; currentUser = e;
        } else { return alert("Ingiza Email sahihi na Password!"); }
        
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');
        document.getElementById('userLabel').innerHTML = `Login: <b>${currentUser}</b>`;
        switchTab('calc');
    }

    function switchTab(t) {
        ['calc-section', 'entry-section', 'list-section', 'admin-section'].forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById(t + '-section').classList.remove('hidden');
        if(t === 'list') renderUserList();
        if(t === 'admin') renderAdminTable();
    }

    // Calculator logic
    let expr = "";
    function press(v) { expr += v; document.getElementById('display').value = expr; }
    function clearC() { expr = ""; document.getElementById('display').value = ""; }
    function calcResult() { try { expr = eval(expr).toString(); document.getElementById('display').value = expr; } catch { clearC(); } }

    // Data handling
    function saveRecord() {
        let m = document.getElementById('mName').value, n = document.getElementById('mPhone').value, a = document.getElementById('mAmount').value;
        let eIdx = parseInt(document.getElementById('editIndex').value);
        if(!m || !a) return alert("Jaza jina na kiasi!");

        let db = JSON.parse(localStorage.getItem('mosha_cloud_v7')) || [];
        if(eIdx > -1) {
            db[eIdx].mteja = m; db[eIdx].namba = n; db[eIdx].kiasi = parseFloat(a);
            alert("Imerekebishwa!");
        } else {
            db.push({ user: currentUser, mteja: m, namba: n, kiasi: parseFloat(a), date: new Date().toLocaleDateString() });
            alert("Imehifadhiwa!");
        }
        localStorage.setItem('mosha_cloud_v7', JSON.stringify(db));
        resetForm(); switchTab('list');
    }

    function resetForm() {
        document.getElementById('mName').value = ''; document.getElementById('mPhone').value = ''; document.getElementById('mAmount').value = '';
        document.getElementById('editIndex').value = "-1";
        document.getElementById('formHeader').innerText = "üìù Sajili Malipo Mpya";
        document.getElementById('saveBtn').innerText = "HIFADHI";
        document.getElementById('saveBtn').className = "btn btn-save";
        document.getElementById('cancelEditBtn').classList.add('hidden');
    }

    function startEdit(idx) {
        let db = JSON.parse(localStorage.getItem('mosha_cloud_v7'));
        let item = db[idx];
        document.getElementById('mName').value = item.mteja;
        document.getElementById('mPhone').value = item.namba;
        document.getElementById('mAmount').value = item.kiasi;
        document.getElementById('editIndex').value = idx;
        document.getElementById('formHeader').innerText = "‚úèÔ∏è Hariri Mauzo";
        document.getElementById('saveBtn').innerText = "UPDATE";
        document.getElementById('saveBtn').className = "btn btn-update";
        document.getElementById('cancelEditBtn').classList.remove('hidden');
        switchTab('entry');
    }

    function sendMessage(type, phone, name, amount) {
        let msg = `Habari ${name}, Asante kwa malipo ya MOSHARUTA WiFi: Tsh ${amount.toLocaleString()}. Karibu tena!`;
        if(type === 'wa') {
            let n = phone.startsWith('0') ? '255' + phone.substring(1) : phone;
            window.open(`https://wa.me/${n}?text=${encodeURIComponent(msg)}`, '_blank');
        } else {
            let sep = (navigator.userAgent.toLowerCase().indexOf("iphone") > -1) ? "&" : "?";
            window.location.href = `sms:${phone}${sep}body=${encodeURIComponent(msg)}`;
        }
    }

    function renderUserList() {
        let db = JSON.parse(localStorage.getItem('mosha_cloud_v7')) || [];
        let myData = db.map((d, i) => ({...d, id: i})).filter(x => x.user === currentUser);
        let h = "<table><thead><tr><th>Mteja</th><th>Kiasi</th><th>Tuma</th></tr></thead><tbody>";
        let total = 0;
        myData.forEach(d => {
            h += `<tr><td>${d.mteja}</td><td>${d.kiasi.toLocaleString()}</td>
            <td><div class="action-container">
                <button class="action-icon" onclick="startEdit(${d.id})">‚úèÔ∏è</button>
                <button class="action-icon" onclick="sendMessage('sms','${d.namba}','${d.mteja}',${d.kiasi})">üîµ</button>
                <button class="action-icon" onclick="sendMessage('wa','${d.namba}','${d.mteja}',${d.kiasi})">üü¢</button>
            </div></td></tr>`;
            total += d.kiasi;
        });
        h += "</tbody></table>";
        document.getElementById('userList').innerHTML = h;
        document.getElementById('userTotal').innerText = total.toLocaleString();
    }

    function renderAdminTable() {
        let db = JSON.parse(localStorage.getItem('mosha_cloud_v7')) || [];
        let html = ""; let grand = 0;
        db.forEach((d, i) => {
            html += `<tr><td><small>${d.user.split('@')[0]}</small></td><td>${d.mteja}</td><td>${d.kiasi.toLocaleString()}</td>
            <td><button class="action-icon" onclick="adminDel(${i})">üóëÔ∏è</button></td></tr>`;
            grand += d.kiasi;
        });
        document.getElementById('adminTable').innerHTML = html;
        document.getElementById('grandTotal').innerText = grand.toLocaleString();
    }

    function adminDel(i) {
        if(confirm("Admin: Futa rekodi hii?")) {
            let db = JSON.parse(localStorage.getItem('mosha_cloud_v7'));
            db.splice(i, 1);
            localStorage.setItem('mosha_cloud_v7', JSON.stringify(db));
            renderAdminTable();
        }
    }

    // Backup Systems
    function genUserBackup() {
        let db = JSON.parse(localStorage.getItem('mosha_cloud_v7')) || [];
        let myData = db.filter(x => x.user === currentUser);
        if(myData.length === 0) return alert("Huna data za kufanyia backup!");
        let code = "MS-" + Math.floor(1000 + Math.random() * 9000);
        localStorage.setItem('backup_' + code, JSON.stringify(myData));
        document.getElementById('uBackupCodeDisp').innerText = "CODE: " + code;
        alert("Backup Imetengenezwa! Itunze Code hii: " + code);
    }

    function restoreUserBackup() {
        let code = prompt("Ingiza Backup Code yako:");
        let data = localStorage.getItem('backup_' + code);
        if(data) {
            let db = JSON.parse(localStorage.getItem('mosha_cloud_v7')) || [];
            let restored = JSON.parse(data);
            localStorage.setItem('mosha_cloud_v7', JSON.stringify([...db, ...restored]));
            alert("Data zimerudishwa!"); renderUserList();
        } else { alert("Code imekosewa!"); }
    }
</script>
</body>
</html>
